{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Settings</title>
</head>
<body class="container">
    <h1 class="w-75 mx-auto">Settings</h1>
    <form id="change-mpw-form" class="w-75 mx-auto">
        <input type="text" name="new-username" id="new-username" class="form-control" placeholder="New username">
        <input type="password" name="old-mpw" id="old-mpw" class="form-control" placeholder="Master Password">
        <input type="password" name="new-mpw" id="new-mpw" class="form-control" placeholder="New Master Password">
        <input type="password" name="confirm-new-mpw" id="confirm-new-mpw" class="form-control" placeholder="Re-enter Master Password">
        <button class="btn bt-primary" type="submit">Change</button>
    </form>
    <script src="{% static 'frontend/getPasswords.js' %}" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <script src="{% static 'frontend/crypto.js' %}" type="text/javascript"></script>
    <script src="{% static 'frontend/patchData.js' %}" type="text/javascript"></script>
    <script src="{% static 'frontend/getCookie.js' %}" type="text/javascript"></script>
    <script src="{% static 'frontend/verifyMasterPassword.js' %}" type="text/javascript"></script>    
    <script src="{% static 'frontend/postData.js' %}" type="text/javascript"></script>
    <script>
        document.querySelector("#change-mpw-form").onsubmit = () => {
            let newMPW = document.querySelector("#new-mpw").value;
            let mpw = document.querySelector("#old-mpw").value;
            let username = document.querySelector("#new-username").value;
            verifyMasterPassword(mpw)
            .then(result => {
                if(result == false) {
                    alert("Wrong master password.")
                    return false;
                }
                let data = {};
                if(username !== '')
                    data.username = username;
                if(newMPW !== '')
                    data.password = newMPW;
                console.log(newMPW);
                // update user data
                patchData('http://127.0.0.1:8000/api/update-user-data', data=data)
                .then(response  => {
                    // couldn't update user data
                    if(!response.ok) {
                        response.json().then(result => alert(JSON.stringify(result)))
                        return false;
                    }
                    // could update user data with new username, but no new master password was given
                    // so don't need to re-encrypt all passwords
                    if(newMPW == "") {
                        console.log("no new mpw");
                        return false;
                    }
                    // update username and master password
                    // re-encrypt all passwords and send the vault to the server
                    getPasswords()
                    .then(passwords => {
                        console.log(passwords);
                        passwords.forEach(password => {
                            // reencrypt passwords
                            let plaintext = decrypt(password.encrypted_password, mpw)
                            let newEncryptedPassword = encrypt(plaintext, newMPW);
                            password.encrypted_password = newEncryptedPassword;
                            console.log("decrypt", decrypt(newEncryptedPassword, newMPW));
                        })
                        // send encrypted passwords
                        patchData('http://127.0.0.1:8000/api/passwords', data={passwords: passwords})
                        .then(response => response.json())
                        .then(result => {
                            alert("User data updated successfully.");
                        })

                    });
                })
                
            })
            return false;
        }
    </script>
</body>
</html>